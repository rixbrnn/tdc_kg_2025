PREFIX : <http://example.org/chinook#>

# Q: Quais gêneros compartilham mais clientes? (Oportunidades de venda cruzada)

SELECT ?genre1Name ?genre2Name 
       (COUNT(DISTINCT ?customer) AS ?sharedCustomers)
WHERE {
  # Padrão: Encontra clientes que compraram de AMBOS os gêneros
  # Isto naturalmente expressa "clientes que gostam de X também gostam de Y"
  
  ?customer :hasInvoice/:hasLine/:lineTrack ?track1 .
  ?track1 :hasGenre ?genre1 .
  ?genre1 :name ?genre1Name .
  
  ?customer :hasInvoice/:hasLine/:lineTrack ?track2 .
  ?track2 :hasGenre ?genre2 .
  ?genre2 :name ?genre2Name .
  
  # Evita valores duplicados e self joins
  FILTER(?genre1 != ?genre2)
  FILTER(STR(?genre1) < STR(?genre2))
}
GROUP BY ?genre1Name ?genre2Name
HAVING (COUNT(DISTINCT ?customer) >= 5)
ORDER BY DESC(?sharedCustomers)
LIMIT 15
