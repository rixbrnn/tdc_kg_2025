PREFIX : <http://example.org/chinook#>

# Q: For each artist, show their top 3 best-selling tracks
#
# Purpose: Show SPARQL handles ranking with subqueries
# Complexity: ⭐⭐⭐ (3/5) - Requires subquery for ranking
# Expected Result: Top 3 tracks per artist with revenue
#
# Demonstrates: SPARQL can do ranking, similar complexity to SQL
# Note: This is one area where SQL and SPARQL are comparable

SELECT ?artistName ?trackName ?revenue
WHERE {
  {
    # Subquery: Calculate revenue per track
    SELECT ?artist ?artistName ?track ?trackName (SUM(?lineTotal) AS ?revenue)
    WHERE {
      ?artist a :Artist ;
              :name ?artistName ;
              :hasAlbum ?album .
      
      ?album :hasTrack ?track .
      ?track :trackName ?trackName .
      
      ?line :lineTrack ?track ;
            :unitPrice ?price ;
            :quantity ?qty .
      
      BIND(?price * ?qty AS ?lineTotal)
    }
    GROUP BY ?artist ?artistName ?track ?trackName
  }
  
  # Filter to top 3 per artist
  # Count how many tracks in same artist have higher revenue
  {
    SELECT ?artist ?track (COUNT(?higherTrack) AS ?rank)
    WHERE {
      ?artist :hasAlbum/:hasTrack ?track .
      
      ?line1 :lineTrack ?track ;
             :unitPrice ?p1 ;
             :quantity ?q1 .
      
      OPTIONAL {
        ?artist :hasAlbum/:hasTrack ?higherTrack .
        ?line2 :lineTrack ?higherTrack ;
               :unitPrice ?p2 ;
               :quantity ?q2 .
        FILTER((?p2 * ?q2) > (?p1 * ?q1))
      }
    }
    GROUP BY ?artist ?track
  }
  
  FILTER(?rank < 3)
}
ORDER BY ?artistName ?rank

# Notes for Presentation:
# ✓ Similar complexity to SQL (both need subqueries)
# ✓ SPARQL's subqueries are more flexible
# ✗ Ranking in SPARQL 1.1 is not as elegant as SQL window functions
#
# SQL advantages here:
# - ROW_NUMBER() OVER (PARTITION BY ...) is cleaner
# - Window functions are SQL's strength
#
# SPARQL advantages:
# - More flexible subquery composition
# - Can easily extend to complex conditions
#
# Real-world use: Bestseller lists, top charts, product rankings
#
# Verdict: This is one case where SQL's window functions shine!
# But SPARQL's flexibility makes up for it in complex scenarios.
