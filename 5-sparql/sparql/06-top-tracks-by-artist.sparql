PREFIX : <http://example.org/chinook#>

# Q: For each artist, show their top 3 best-selling tracks

SELECT ?artistName ?trackName ?revenue
WHERE {
  {
    # Subquery: Calculate revenue per track
    SELECT ?artist ?artistName ?track ?trackName (SUM(?lineTotal) AS ?revenue)
    WHERE {
      ?artist a :Artist ;
              :name ?artistName ;
              :hasAlbum ?album .
      
      ?album :hasTrack ?track .
      ?track :trackName ?trackName .
      
      ?line :lineTrack ?track ;
            :unitPrice ?price ;
            :quantity ?qty .
      
      BIND(?price * ?qty AS ?lineTotal)
    }
    GROUP BY ?artist ?artistName ?track ?trackName
  }
  
  # Filter to top 3 per artist
  # Count how many tracks in same artist have higher revenue
  {
    SELECT ?artist ?track (COUNT(?higherTrack) AS ?rank)
    WHERE {
      ?artist :hasAlbum/:hasTrack ?track .
      
      ?line1 :lineTrack ?track ;
             :unitPrice ?p1 ;
             :quantity ?q1 .
      
      OPTIONAL {
        ?artist :hasAlbum/:hasTrack ?higherTrack .
        ?line2 :lineTrack ?higherTrack ;
               :unitPrice ?p2 ;
               :quantity ?q2 .
        FILTER((?p2 * ?q2) > (?p1 * ?q1))
      }
    }
    GROUP BY ?artist ?track
  }
  
  FILTER(?rank < 3)
}
ORDER BY ?artistName ?rank
