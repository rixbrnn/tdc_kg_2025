PREFIX :   <http://example.org/chinook#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Q1 (SPARQL solution)
# For each customer, what is their favorite genre
# (the genre where they spent the most money)?

# Assumptions:
# - :Customer :hasInvoice :Invoice
# - :Invoice :hasLine :InvoiceLine
# - :InvoiceLine :unitPrice, :quantity, :lineTrack
# - :Track :hasGenre :Genre
# - :Genre :name ?genreName
# - :Customer :fullName ?customerName

SELECT ?customer ?customerName ?genreName ?amount
WHERE {
  # Bind a specific customer in the outer pattern
  ?customer a :Customer ;
            :fullName ?customerName .

  # For that customer, find the genre with the highest revenue
  {
    SELECT ?customer ?genreName (SUM(?lineTotal) AS ?amount)
    WHERE {
      ?customer :hasInvoice ?inv .
      ?inv :hasLine ?line .

      ?line :unitPrice ?price ;
            :quantity  ?qty ;
            :lineTrack ?track .

      ?track :hasGenre ?genre .
      ?genre :name ?genreName .

      BIND(xsd:decimal(?price) * xsd:decimal(?qty) AS ?lineTotal)
    }
    GROUP BY ?customer ?genreName
    ORDER BY DESC(?amount)
    LIMIT 1       # <-- favorite genre for THIS customer
  }
}
ORDER BY DESC(?amount);

# Note: This uses a correlated subselect: for each ?customer in the outer query, the inner SELECT sees that binding and returns only that customerâ€™s invoices, then picks the top genre (ORDER BY DESC(?amount) LIMIT 1).