PREFIX :   <http://example.org/chinook#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Q1 (SPARQL solution)
# For each customer, what is their favorite genre
# (the genre where they spent the most money)?

SELECT ?customer ?customerName ?genreName ?genreRevenue
WHERE {
  # 1) Revenue per (customer, genre)
  {
    SELECT ?customer ?genre ?genreName (SUM(?lineTotal) AS ?genreRevenue)
    WHERE {
      ?customer a :Customer ;
                :hasInvoice ?inv .

      ?inv :hasLine ?line .

      ?line :unitPrice ?price ;
            :quantity  ?qty ;
            :lineTrack ?track .

      ?track :hasGenre ?genre .
      ?genre :name ?genreName .

      BIND(xsd:decimal(?price) * xsd:decimal(?qty) AS ?lineTotal)
    }
    GROUP BY ?customer ?genre ?genreName
  }

  # 2) Max revenue per customer (over all their genres)
  {
    SELECT ?customer (MAX(?genreRevenue2) AS ?maxRevenue)
    WHERE {
      {
        SELECT ?customer ?genre (SUM(?lineTotal2) AS ?genreRevenue2)
        WHERE {
          ?customer a :Customer ;
                    :hasInvoice ?inv2 .

          ?inv2 :hasLine ?line2 .

          ?line2 :unitPrice ?price2 ;
                 :quantity  ?qty2 ;
                 :lineTrack ?track2 .

          ?track2 :hasGenre ?genre .

          BIND(xsd:decimal(?price2) * xsd:decimal(?qty2) AS ?lineTotal2)
        }
        GROUP BY ?customer ?genre
      }
    }
    GROUP BY ?customer
  }

  # 3) Attach customer name
  ?customer :fullName ?customerName .

  # Keep only the genre(s) that reach the max revenue for that customer
  FILTER(?genreRevenue = ?maxRevenue)
}
ORDER BY DESC(?genreRevenue)
